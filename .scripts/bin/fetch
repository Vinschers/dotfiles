#!/bin/sh

red='31m'
green='32m'
yellow='33m'
blue='34m'
magenta='35m'
cyan='36m'
white='37m'
grey='90m'

margin=4

print_color() {
	color="$1"
	text="$2"
	printf "\033[33;%s%s\033[33;0m" "$color" "$text"
}

print_header() {
	printf "\033[%sG" $((image_width + margin))

	printf "%s\n" "$1"
}

print_info() {
	icon="$1"
	info="$2"

	printf "\033[%sG" $((image_width + margin))

	printf "  "
	print_color "$blue" "$icon"
	printf "  "
	print_color "$magenta" "$info"
	printf "\n"
}

print_logo() {
	width=28
	height=28

	echo ""
	chafa "$XDG_CONFIG_HOME/fetch/logo.png" -s "${width}x${height}"

	image_height=12
	image_width=30
}

get_distro() {
	distro=$(lsb_release -sd)
	distro=${distro##[\"\']}
	distro=${distro%%[\"\']}

	echo "$distro"
}

get_uptime() {
	IFS=. read -r s _ </proc/uptime
	d=$((s / 60 / 60 / 24))
	h=$((s / 60 / 60 % 24))
	m=$((s / 60 % 60))

	case "$d" in
	[!0]*)
		uptime="${uptime}${d}d "
		;;
	esac

	case "$h" in
	[!0]*)
		uptime="${uptime}${h}h "
		;;
	esac

	case "$m" in
	[!0]*)
		uptime="${uptime}${m}m "
		;;
	esac
	echo "${uptime:-0m}"
}

get_packages() {
	pacman -Qq | wc -l
}

get_memory() {
	free -m | sed '2q;d' | awk '{printf ("%.1f GB / %.1f GB", $3/1024, $2/1024)}'
}

get_wm() {
	echo "$XDG_CURRENT_DESKTOP ($(echo "$XDG_SESSION_TYPE" | sed 's/.*/\u&/'))"
}

get_disk() {
	df ~ -B 1GB --output=used,avail | sed 1d | awk '{print $1" GB / "$2" GB"}'
}

get_cpu() {
	grep "model name" /proc/cpuinfo | head -n 1 | awk -F':' '{print $2}' | awk '{$1=$1;print}'
}

get_gpu() {
	info="$(lspci | grep VGA | head -n 1)"

	case "$info" in
	*NVIDIA*)
		echo "NVIDIA $(echo "$info" | cut -d "[" -f2 | cut -d "]" -f1)"
		;;
	*Intel*)
		echo "${info#*: }" | cut -d ":" -f2 | cut -d "(" -f1
		;;
	esac
}

get_colors() {
	printf "\033[33;0m "
	print_color "$red" "  "
	print_color "$green" "  "
	print_color "$yellow" "  "
	print_color "$blue" "  "
	print_color "$magenta" "  "
	print_color "$cyan" "  "
	print_color "$white" "  "
	print_color "$grey" "  "
	printf "\033[33;0m "
}

display_info() {
	print_header "┌──────────── Hardware Information ────────────┐"
	print_info "" "$(get_cpu)"
	print_info "󱄄" "$(get_gpu)"
	print_info "" "$(get_memory)"
	print_info "" "$(get_disk)"
	print_header "├──────────── Software Information ────────────┤"
	print_info "" "$(get_distro)"
	print_info "" "$(get_uptime)"
	print_info "" "$(get_wm)"
	print_info "" "${SHELL##*/}"
	print_info "" "$TERM"
	print_info "" "$(get_packages)"
	print_info "" "$(get_colors)"
	print_header "└──────────────────────────────────────────────┘"
}

main() {
    tput rmam # Disable line wrapping

	print_logo

	i=0
	while [ "$i" -lt "$image_height" ]; do
		printf "%s" "$(tput cuu1)"
		i=$((i + 1))
	done

	display_info

    tput smam # Enable line wrapping
}

main

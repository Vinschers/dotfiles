#!/bin/sh

SIZE=20
MARGIN=1
HEAD_SIZE=2
WIDTH=4
PADDING=3

HEIGHT=$(( SIZE - 2 * MARGIN - 4 ))

draw_battery () {
    PERCENTAGE="$1"
    PERCENTAGE=$(( HEIGHT * PERCENTAGE / 100 ))

    printf "^v^"
    printf "^c%s^^r0,0,%s,%s^" "$2" "$(( WIDTH + 2 + PADDING ))" "$SIZE"

    printf "^c#A7A7A7^"
    printf "^r%s,%s,%s,2^" "$(( WIDTH / 2 ))" "$MARGIN" "$HEAD_SIZE"

    printf "^r0,%s,%s,%s^" "$(( MARGIN + 1 ))" "$(( WIDTH + 2 ))" "$(( HEIGHT + 2 ))"
    printf "^c#4C566A^^r1,%s,%s,%s^" "$(( MARGIN + 2 ))" "$WIDTH" "$HEIGHT"
    printf "^t^"

    printf "^r1,%s,%s,%s^" "$(( HEIGHT -  PERCENTAGE + MARGIN + 2 ))" "$WIDTH" "$PERCENTAGE"
    printf "^f%s^%s%%" "$(( WIDTH + 2 + PADDING ))" "$1"
}

printf "^c%s^" "$1"
if [ "$(ls /sys/class/power_supply)" = "" ];
then
    draw_battery 100 "$2"
	exit 0
fi

battery_info=""

for battery in /sys/class/power_supply/BAT?*; do
	capacity="$(cat "$battery/capacity" 2>&1)"
	battery_status="$(cat "$battery/status" 2>&1)"

    battery_info="$battery_info^v^"

    if [ "$battery_status" = "Charging" ]
    then
        battery_info="$battery_info^c#00B300^"
    fi

    battery_info="$battery_info$(draw_battery "$capacity" "$2")"

    battery_info="$battery_info^t^ "
done

printf "%s" "${battery_info%?}"

case $BUTTON in
	6) "$TERMINAL" -e "$EDITOR" "$0" ;;
esac

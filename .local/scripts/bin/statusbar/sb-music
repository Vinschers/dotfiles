#!/bin/sh

. sb-style
get_spotify() {

	player="$(spot-cli -q)"

	[ -z "$player" ] && return 1
    [ "$player" = "netflix" ] && return 1

	state="$(dbus-send --print-reply --dest=org.mpris.MediaPlayer2."$player" /org/mpris/MediaPlayer2 org.freedesktop.DBus.Properties.Get string:"org.mpris.MediaPlayer2.Player" string:'PlaybackStatus' | grep -Ev "^method" | grep -Eo '("(.*)")|(\b[0-9][a-zA-Z0-9.]*\b)' | cut -f2 -d'"')"

	case "$state" in
	Stopped)
		return 1
		;;
	Playing)
		icon=""
		;;
	Paused)
		icon=""
		;;
	esac

    printf "%s§%s" "$icon" "$(dbus-send --print-reply --dest=org.mpris.MediaPlayer2."$player" /org/mpris/MediaPlayer2 org.freedesktop.DBus.Properties.Get string:"org.mpris.MediaPlayer2.Player" string:'Metadata' | grep -Ev "^method" | grep -Eo '("(.*)")|(\b[0-9][a-zA-Z0-9.]*\b)' | sed -E '2~2 a|' | tr -d '\n' | sed -E 's/\|/\n/g;s/(xesam:)|(mpris:)//' | sed -E 's/^"//;s/"$//;s/"+/|/;s/ +/ /g' | grep -Ew 'title|albumArtist' | sort | cut -f2 -d'|' | sed '/^[[:space:]]*$/d;s/^[[:space:]]*//' | tr '\n' '|' | awk -F'|' '{print $1"§"$2}')"
}

get_mpd() {
	return 1
}

output="$(get_spotify)" && [ -n "$output" ] && STYLE=6
[ -z "$output" ] && output="$(get_mpd)" && [ -n "$output" ] && STYLE=7

[ -z "$output" ] && exit

icon="${output%%§*}"
info="${output#*§}"

song="${info%§*}"
artist="${info#*§}"

fg="$(get_fg $STYLE)"
bg_icon="$(get_bg_icon $STYLE)"
bg_text="$(get_bg_text $STYLE)"

MAX_LENGTH=18

if [ ${#song} -gt $MAX_LENGTH ]; then
	song="$(printf '%s' "$song" | cut -c -$((MAX_LENGTH - 3)))..."
fi

if [ ${#artist} -gt $MAX_LENGTH ]; then
	artist="$(printf '%s' "$artist" | cut -c -$((MAX_LENGTH - 3)))..."
fi

printf "%s%s" "$bg_icon" "$fg"
printf " %s " "$icon"
printf "%s" "$bg_text"
printf " %s " "$song | $artist"
printf "%s" "$(get_color_reset)"

case $BUTTON in
6) "$TERMINAL" -e "$EDITOR" "$0" ;;
esac

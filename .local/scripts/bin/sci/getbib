#!/bin/sh
[ -z "$1" ] && echo "Give either a pdf file or a DOI as an argument." && exit

if [ -f "$1" ]; then
	# Try to get DOI from pdfinfo or pdftotext output.
	identifier=$(pdfinfo "$1" | grep -io "doi:.*") ||
	identifier=$(pdftotext "$1" 2>/dev/null - | grep -io "doi:\s*\S\+[[:alnum:]]" -m 1) ||
	exit 1
else
	identifier="$1"
fi

zotero () {
    BIB_STR="$(curl -fsd "$identifier" -H "Content-Type: text/plain" "http://localhost:1969/search")"
    if [ "$BIB_STR" = "No items returned from any translator" ] || [ "$BIB_STR" = "No identifiers found" ]
    then
        return 1
    fi

    URL="$(echo "$BIB_STR" | jq -r '.[0]?.url')"

    if [ "$URL" = "null" ]
    then
        JSON="$BIB_STR"
    else
        JSON="$(curl -fsd "$URL" -H "Content-Type: text/plain" "http://localhost:1969/web")"
    fi

    echo "$JSON" | curl -fsd @- -H "Content-Type: application/json" "http://localhost:1969/export?format=biblatex"
}

openlibrary () {
    JSON="$(curl -sd "https://openlibrary.org/isbn/$identifier" -H "Content-Type: text/plain" "http://localhost:1969/web")"

    curl -fsd "$JSON" -H "Content-Type: application/json" "http://localhost:1969/export?format=biblatex"
}

input () {
    printf "\n%s" "$(vipe --suffix bib)"
}

zotero || openlibrary || input

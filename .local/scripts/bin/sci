#!/bin/sh


get_pdf_path () {
    BIB_STR="$1"

    BIB_ID_TYPE="$(python -c "import bibtexparser; entry = bibtexparser.bparser.BibTexParser(common_strings=True).parse(\"\"\"$BIB_STR\"\"\").entries[0]; print(entry['ID']); print(entry['ENTRYTYPE']); print(entry['title'])")"
    BIBID="$(echo "$BIB_ID_TYPE" | sed '1q;d')"
    BIBTYPE="$(echo "$BIB_ID_TYPE" | sed '2q;d')"
    BIBTITLE="$(echo "$BIB_ID_TYPE" | sed '3q;d' | sed -e "s/\\\\//g")"

    case "$BIBTYPE" in
        book)
            PDF_PATH="$BIBLIOGRAPHY_DIRECTORY/$BIBTYPE/$BIBTITLE.pdf"
            ;;
        *)
            PDF_PATH="$BIBLIOGRAPHY_DIRECTORY/$BIBTYPE/$BIBID.pdf"
            ;;
    esac

    echo "$PDF_PATH"
}
export -f get_pdf_path

extract_identifier () {
    ID="$(echo "$@" | grep -Po "(10\.[0-9a-zA-Z]+\/(?:(?![\"&\'])\S)+)\b")"
    [ -n "$ID" ] && echo "doi $ID" && return 0
    
    ID="$(echo "$@" | grep -Po "^(?=(?:\D*\d){10}(?:(?:\D*\d){3})?$)[\d-]+\$")"
    [ -n "$ID" ] && echo "isbn $(echo "$ID" | sed -e "s/-//g")" && return 0

    echo "N $*"
}

[ -z "$1" ] && sci_open && exit 0

BIB_FILE="$(find . -maxdepth 1 -name "*.bib" -print -quit)"
[ -z "$BIB_FILE" ] && BIB_FILE="$(find_up . -name "*.bib" -print -quit)"

[ -n "$BIB_FILE" ] && [ "$(dirname "$(realpath "$BIB_FILE")")" = "$(realpath "$BIBLIOGRAPHY_DIRECTORY")" ] && BIB_FILE=""

case "$1" in
    init)
        touch library.bib
        mkdir bibliography
        ;;
    add)
        shift

        if [ -z "$1" ]
        then
            ID="$(dmenu -p "Identifier: " < /dev/null)"
        else
            ID="$1"
        fi

        TYPE_ID="$(extract_identifier "$ID")"

        DIFF="$(sci_add $TYPE_ID "$BIB_FILE")"
        [ "$DIFF" = "1" ] && [ -f "$BIB_FILE" ] && sci_update "$BIB_FILE"

        ;;

    open)
        shift

        ID="$(extract_identifier "$1" | cut -d' ' -f 2-)"
        sci_open "$ID" "$BIB_FILE"
        ;;

    update)
        [ -f "$BIB_FILE" ] && sci_update "$BIB_FILE"
        ;;

    *)
        TYPE_ID="$(extract_identifier "$1")"

        DIFF="$(sci_add $TYPE_ID "$BIB_FILE")"

        if [ -f "$BIB_FILE" ] && [ "$DIFF" = "1" ]
        then
            sci_update "$BIB_FILE"
        else
            sci_open "$(echo "$TYPE_ID" | cut -d' ' -f 2-)" "$BIB_FILE"
        fi
        ;;
esac


#!/bin/sh


extract_identifier () {
    ID="$(echo "$1" | grep -Po "(10\.[0-9a-zA-Z]+\/(?:(?\![\"&\'])\S)+)\b")"
    [ -n "$ID" ] && echo "$ID doi" && return 0
    
    ID="$(echo "$1" | grep -Po "^(?=(?:\D*\d){10}(?:(?:\D*\d){3})?$)[\d-]+\$")"
    [ -n "$ID" ] && echo "$ID isbn" && return 0

    return 1
}

[ -z "$1" ] && sci_open && exit 0

BIB_FILE="$(find . -maxdepth 3 -name "*.bib" -print -quit)"
[ -z "$BIB_FILE" ] && BIB_FILE="$(find_up . -name "*.bib" -print -quit)"

case "$1" in
    init)
        touch library.bib
        mkdir bibliography
        ;;
    add)
        shift

        ID_TYPE="$(extract_identifier "$1")"

        DIFF="$(sci_add "$ID_TYPE" "$BIB_FILE")"
        [ "$DIFF" = "1" ] && [ -f "$BIB_FILE" ] && sci_update "$BIB_FILE"

        ;;

    open)
        shift

        ID="$(extract_identifier "$1" | awk '{print $1}')"
        sci_open "$ID" "$BIB_FILE"
        ;;

    update)
        [ -f "$BIB_FILE" ] && sci_update "$BIB_FILE"
        ;;

    *)
        ID_TYPE="$(extract_identifier "$1")"

        DIFF="$(sci_add "$ID_TYPE" "$BIB_FILE")"

        if [ -f "$BIB_FILE" ] && [ "$DIFF" = "1" ]
        then
            sci_update "$BIB_FILE"
        else
            sci_open "$(echo "$ID_TYPE" | awk '{print $1}')" "$BIB_FILE"
        fi
        ;;
esac


#!/bin/sh
[ -z "$1" ] && echo "Give either a pdf file or a DOI as an argument." && exit

if [ -f "$1" ]; then
	# Try to get DOI from pdfinfo or pdftotext output.
	identifier=$(pdfinfo "$1" | grep -io "doi:.*") ||
	identifier=$(pdftotext "$1" 2>/dev/null - | grep -io "doi:\s*\S\+[[:alnum:]]" -m 1) ||
	exit 1
else
	identifier="$1"
fi

BIB_STR="$(curl -sd "$identifier" -H "Content-Type: text/plain" "http://localhost:1969/search")"
URL="$(echo "$BIB_STR" | jq -r '.[]?.url')"

if [ "$URL" = "null" ]
then
    JSON="$BIB_STR"
else
    JSON="$(curl -sd "$URL" -H "Content-Type: text/plain" "http://localhost:1969/web")"
fi

echo "$JSON" | curl -sd @- -H "Content-Type: application/json" "http://localhost:1969/export?format=biblatex"

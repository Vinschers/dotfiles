---
- name: Bootstrap personal environment
  hosts: localhost
  vars_prompt:
    - name: ssd_trim
      prompt: Setup SSD trim? [Y/n]
      private: false
    - name: github_email
      prompt: Github email
      private: false

  tasks:
    - name: Check for dotfiles
      stat:
        path: "{{ ansible_env.HOME }}/.config/.dotfiles-git/HEAD"
      register: dotfiles_head
    - name: Setup dotfiles repository
      when: not dotfiles_head.stat.exists
      block:
        - name: Clone repository
          shell: |
            git clone --bare https://github.com/Vinschers/dotfiles.git "{{ ansible_env.HOME }}/.config/.dotfiles-git"
        - name: Install dotfiles
          shell: |
            git --git-dir="{{ ansible_env.HOME }}/.config/.dotfiles-git/" --work-tree="{{ ansible_env.HOME }}" checkout 2>&1 | egrep "\s+\." | awk {'print $1'} | xargs -I{} rm $HOME/{}
            git --git-dir="{{ ansible_env.HOME }}/.config/.dotfiles-git/" --work-tree="{{ ansible_env.HOME }}" checkout

            git --git-dir="{{ ansible_env.HOME }}/.config/.dotfiles-git/" --work-tree="{{ ansible_env.HOME }}" config --local status.showUntrackedFiles no
            git --git-dir="{{ ansible_env.HOME }}/.config/.dotfiles-git/" --work-tree="{{ ansible_env.HOME }}" update-index --assume-unchanged "{{ ansible_env.HOME }}/.config/shell/environment/local.sh"
            git --git-dir="{{ ansible_env.HOME }}/.config/.dotfiles-git/" --work-tree="{{ ansible_env.HOME }}" update-index --assume-unchanged "{{ ansible_env.HOME }}/.config/octave/octaverc"

    - name: Setup Arch Linux
      import_role:
        name: arch
